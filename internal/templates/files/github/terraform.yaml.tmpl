## This file is auto generated by tfskel

name: TF plan & apply envs/{{.Env}}/{{.Region}}/{{.AppDir}} terraform files
on:
  pull_request:
    branches:
      - main
    paths:
      - 'envs/{{.Env}}/{{.Region}}/{{.AppDir}}/**'
      - '.github/workflows/{{.WorkflowFileName}}'

  push:
    branches:
      - main
    paths:
      - 'envs/{{.Env}}/{{.Region}}/{{.AppDir}}/**'
      - '.github/workflows/{{.WorkflowFileName}}'

  ## For manual trigger on github UI
  workflow_dispatch:
    inputs:
      terraform_files_path:
        type: string
        required: true
        default: 'envs/{{.Env}}/{{.Region}}/{{.AppDir}}'
        description: Path to the Terraform files to validate
      aws_region:
        type: string
        required: true
        default: {{.Region}}
        description: The AWS region in which terraform resources should be deployed.
      aws_role_to_assume:
        type: string
        required: true
        default: "{{.AWSRoleArn}}"
        description: The AWS role to assume for the terraform deployment.
      ## Note: It is not recommended to enable apply on PR for production environments.
      enable_apply_on_pr:
        type: boolean
        required: false
        default: false
        description: Enable terraform apply on pull request. This is not recommended for production environments.
      environment:
        type: string
        required: true
        default: {{.Env}}
        description: The environment in which the terraform resources should be deployed.

jobs:
  terraform-plan-apply:
    uses: ./.github/workflows/reusable-terraform-plan-apply.yaml
    with:
      terraform_files_path: 'envs/{{.Env}}/{{.Region}}/{{.AppDir}}'
      aws_region: {{.Region}}
      ## Cyclic dependency for bootstrap, need local apply for the first time.
      aws_role_to_assume: "{{.AWSRoleArn}}"
      environment: {{.Env}}
      enable_apply_on_pr: false # set to true to enable apply on PR, not recommended for production environments.
